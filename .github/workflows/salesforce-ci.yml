name: Salesforce CI on Windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  salesforce-ci:
    runs-on: windows-latest

    env:
      SF_ENV_ALIAS: scratchOrg
      SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}

    steps:
      - name: 🧾 Checkout Repository
        uses: actions/checkout@v3

      - name: ⚙️ Install Salesforce CLI (via Chocolatey)
        run: |
          choco install salesforcecli -y
        shell: powershell

      - name: 🔐 Authorize Dev Hub
        run: |
          Set-Content -Path auth.txt -Value "$env:SFDX_AUTH_URL"
          sfdx auth:sfdxurl:store --sfdxurlfile auth.txt --setdefaultdevhubusername --setalias DevHub
        shell: powershell

      - name: 🏗️ Create Scratch Org
        run: |
          sfdx force:org:create --definitionfile config/project-scratch-def.json --alias $env:SF_ENV_ALIAS --durationdays 1 --setdefaultusername
        shell: powershell

      - name: 🚀 Deploy Metadata
        run: |
          sfdx force:source:deploy --targetusername $env:SF_ENV_ALIAS --sourcepath force-app
        shell: powershell

      - name: 🧪 Run Apex Tests
        run: |
          New-Item -ItemType Directory -Path test-results -Force
          sfdx force:apex:test:run --targetusername $env:SF_ENV_ALIAS --testlevel RunLocalTests --resultformat junit --outputdir test-results --wait 10
        shell: powershell

      - name: 📄 Publish Test Report
        uses: actions/upload-artifact@v4
        with:
          name: apex-test-results
          path: test-results

      - name: 🧹 Delete Scratch Org
        if: always()
        run: |
          sfdx force:org:delete --targetusername $env:SF_ENV_ALIAS --noprompt
        shell: powershell
