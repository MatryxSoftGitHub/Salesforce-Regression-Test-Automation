name: Salesforce CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  salesforce-ci:
    runs-on: windows-latest

    env:
      SF_ENV_ALIAS: scratchOrg
      SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}

    steps:
      - name: 🧾 Checkout Repo
        uses: actions/checkout@v3

      - name: ⚙️ Setup Salesforce CLI
        uses: sfdx-actions/setup-sfdx@v1

      - name: 🔐 Authorize Dev Hub
        shell: pwsh
        run: |
          Set-Content -Path auth.txt -Value "$env:SFDX_AUTH_URL"
          sfdx auth:sfdxurl:store --sfdxurlfile auth.txt --setdefaultdevhubusername --setalias DevHub

      - name: 🏗️ Create Scratch Org
        shell: pwsh
        run: |
          sfdx org create scratch --definition-file config/project-scratch-def.json --alias $env:SF_ENV_ALIAS --duration-days 1 --set-default

      - name: 🚀 Deploy Metadata
        shell: pwsh
        run: |
          sfdx project deploy start --target-org $env:SF_ENV_ALIAS --ignore-conflicts

      - name: 🧪 Run Apex Tests
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path test-results -Force
          sfdx apex run test --target-org $env:SF_ENV_ALIAS --test-level RunLocalTests --result-format junit --output-dir test-results

      - name: 📄 Publish Test Report
        uses: actions/upload-artifact@v4
        with:
          name: apex-test-results
          path: test-results

      - name: 🧹 Delete Scratch Org
        if: always()
        shell: pwsh
        run: |
          sfdx org delete scratch --target-org $env:SF_ENV_ALIAS --no-prompt
