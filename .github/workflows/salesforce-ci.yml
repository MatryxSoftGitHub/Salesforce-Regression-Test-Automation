name: Salesforce CI on Windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  salesforce-ci:
    runs-on: windows-latest

    env:
      SF_ENV_ALIAS: scratchOrg
      SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}

    steps:
      - name: üßæ Checkout Repository
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Manually Install Salesforce CLI on Windows
        run: |
          Invoke-WebRequest -Uri https://developer.salesforce.com/media/salesforce-cli/sfdx-windows-x64.exe -OutFile sfdx-windows-x64.exe
          Start-Process .\sfdx-windows-x64.exe -Wait -ArgumentList "/quiet /norestart"
        shell: powershell

      - name: üîê Authorize Dev Hub
        run: |
          Set-Content -Path auth.txt -Value "$env:SFDX_AUTH_URL"
          sf org login sfdx-url --sfdx-url-file auth.txt --set-default-dev-hub --alias DevHub
        shell: powershell

      - name: üèóÔ∏è Create Scratch Org
        run: |
          sf org create scratch --definition-file config/project-scratch-def.json --alias $env:SF_ENV_ALIAS --duration-days 1 --set-default
        shell: powershell

      - name: üöÄ Deploy Metadata
        run: |
          sf project deploy start --target-org $env:SF_ENV_ALIAS --ignore-conflicts
        shell: powershell

      - name: üß™ Run Apex Tests
        run: |
          New-Item -ItemType Directory -Path test-results -Force
          sf apex run test --target-org $env:SF_ENV_ALIAS --test-level RunLocalTests --result-format junit --output-dir test-results
        shell: powershell

      - name: üìÑ Publish Test Report
        uses: actions/upload-artifact@v4
        with:
          name: apex-test-results
          path: test-results

      - name: üßπ Delete Scratch Org
        if: always()
        run: |
          sf org delete scratch --target-org $env:SF_ENV_ALIAS --no-prompt
        shell: powershell
